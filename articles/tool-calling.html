<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Tool/function calling • ellmer</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Tool/function calling">
<script defer data-domain="ellmer.tidyverse.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ellmer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/ellmer.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/programming.html">Programming with ellmer</a></li>
    <li><a class="dropdown-item" href="../articles/prompt-design.html">Prompt design</a></li>
    <li><a class="dropdown-item" href="../articles/streaming-async.html">Streaming and async APIs</a></li>
    <li><a class="dropdown-item" href="../articles/structured-data.html">Structured data</a></li>
    <li><a class="dropdown-item" href="../articles/tool-calling.html">Tool/function calling</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2025/05/ellmer-0-2-0/">Version 0.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://posit.co/blog/announcing-ellmer/">Version 0.1.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidyverse/ellmer/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Tool/function calling</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/ellmer/blob/pkgdown-v0.2.1/vignettes/tool-calling.Rmd" class="external-link"><code>vignettes/tool-calling.Rmd</code></a></small>
      <div class="d-none name"><code>tool-calling.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>One of the most interesting aspects of modern chat models is their
ability to make use of external tools that are defined by the
caller.</p>
<p>When making a chat request to the chat model, the caller advertises
one or more tools (defined by their function name, description, and a
list of expected arguments), and the chat model can choose to respond
with one or more “tool calls”. These tool calls are requests <em>from
the chat model to the caller</em> to execute the function with the given
arguments; the caller is expected to execute the functions and “return”
the results by submitting another chat request with the conversation so
far, plus the results. The chat model can then use those results in
formulating its response, or, it may decide to make additional tool
calls.</p>
<p><em>Note that the chat model does not directly execute any external
tools!</em> It only makes requests for the caller to execute them. It’s
easy to think that tool calling might work like this:</p>
<div class="float">
<img src="tool-calling-wrong.svg" alt="Diagram showing showing the wrong mental model of tool calls: a user initiates a request that flows to the assistant, which then runs the code, and returns the result back to the user.”"><div class="figcaption">Diagram showing showing the wrong mental model
of tool calls: a user initiates a request that flows to the assistant,
which then runs the code, and returns the result back to the
user.”</div>
</div>
<p>But in fact it works like this:</p>
<div class="float">
<img src="tool-calling-right.svg" alt="Diagram showing the correct mental model for tool calls: a user sends a request that needs a tool call, the assistant request that the user’s runs that tool, returns the result to the assistant, which uses it to generate the final answer."><div class="figcaption">Diagram showing the correct mental model for
tool calls: a user sends a request that needs a tool call, the assistant
request that the user’s runs that tool, returns the result to the
assistant, which uses it to generate the final answer.</div>
</div>
<p>The value that the chat model brings is not in helping with
execution, but with knowing when it makes sense to call a tool, what
values to pass as arguments, and how to use the results in formulating
its response.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ellmer.tidyverse.org">ellmer</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="motivating-example">Motivating example<a class="anchor" aria-label="anchor" href="#motivating-example"></a>
</h3>
<p>Let’s take a look at an example where we really need an external
tool. Chat models generally do not know the current time, which makes
questions like these impossible.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_openai.html">chat_openai</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"gpt-4o"</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"How long ago exactly was the moment Neil Armstrong touched down on the moon?"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Neil Armstrong touched down on the moon on July 20, 1969, at 20:17 UTC. To determine how long ago that</span></span>
<span><span class="co">#&gt; was from the current year of 2023, we can calculate the difference in years, months, and days.</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; From July 20, 1969, to July 20, 2023, is exactly 54 years. If today's date is after July 20, 2023, you</span></span>
<span><span class="co">#&gt; would add the additional time since then. If it is before, you would consider slightly less than 54</span></span>
<span><span class="co">#&gt; years.</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; As of right now, can you confirm the current date so we can calculate the precise duration?</span></span></code></pre></div>
<p>Unfortunately, this example was run on September 18, 2024. Let’s give
the chat model the ability to determine the current time and try
again.</p>
</div>
<div class="section level3">
<h3 id="defining-a-tool-function">Defining a tool function<a class="anchor" aria-label="anchor" href="#defining-a-tool-function"></a>
</h3>
<p>The first thing we’ll do is define an R function that returns the
current time. This will be our tool.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Gets the current time in the given time zone.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param tz The time zone to get the current time in.</span></span>
<span><span class="co">#' @return The current time in the given time zone.</span></span>
<span><span class="va">get_current_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tz</span> <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, tz <span class="op">=</span> <span class="va">tz</span>, usetz <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that we’ve gone through the trouble of creating <a href="https://roxygen2.r-lib.org/" class="external-link">roxygen2 comments</a>. This is a very
important step that will help the model use your tool correctly!</p>
<p>Let’s test it:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">get_current_time</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2024-09-18 17:47:14 UTC"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="registering-tools">Registering tools<a class="anchor" aria-label="anchor" href="#registering-tools"></a>
</h3>
<p>Now we need to tell our chat object about our
<code>get_current_time</code> function. This by creating and registering
a tool:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_openai.html">chat_openai</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"gpt-4o"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">register_tool</span><span class="op">(</span><span class="fu"><a href="../reference/tool.html">tool</a></span><span class="op">(</span></span>
<span>  <span class="va">get_current_time</span>,</span>
<span>  <span class="st">"Gets the current time in the given time zone."</span>,</span>
<span>  tz <span class="op">=</span> <span class="fu"><a href="../reference/type_boolean.html">type_string</a></span><span class="op">(</span></span>
<span>    <span class="st">"The time zone to get the current time in. Defaults to `\"UTC\"`."</span>,</span>
<span>    required <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This is a fair amount of code to write, even for such a simple
function as <code>get_current_time</code>. Fortunately, you don’t have
to write this by hand! I generated the above <code>register_tool</code>
call by calling <code>create_tool_def(get_current_time)</code>, which
printed that code at the console. <code><a href="../reference/create_tool_def.html">create_tool_def()</a></code> works
by passing the function’s signature and documentation to GPT-4o, and
asking it to generate the <code>register_tool</code> call for you.</p>
<p>Note that <code><a href="../reference/create_tool_def.html">create_tool_def()</a></code> may not create perfect
results, so you must review the generated code before using it. But it
is a huge time-saver nonetheless, and removes the tedious boilerplate
generation you’d have to do otherwise.</p>
</div>
<div class="section level3">
<h3 id="using-the-tool">Using the tool<a class="anchor" aria-label="anchor" href="#using-the-tool"></a>
</h3>
<p>That’s all we need to do! Let’s retry our query:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"How long ago exactly was the moment Neil Armstrong touched down on the moon?"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Neil Armstrong touched down on the moon on July 20, 1969, at 20:17 UTC.</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; To calculate the time elapsed from that moment until the current time (September 18, 2024, 17:47:19</span></span>
<span><span class="co">#&gt; UTC), we need to break it down.</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; 1. From July 20, 1969, 20:17 UTC to July 20, 2024, 20:17 UTC is exactly 55 years.</span></span>
<span><span class="co">#&gt; 2. From July 20, 2024, 20:17 UTC to September 18, 2024, 17:47:19 UTC, we need to further break down:</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt;    - From July 20, 2024, 20:17 UTC to September 18, 2024, 17:47:19 UTC, which is:</span></span>
<span><span class="co">#&gt;      - 1 full month (August)</span></span>
<span><span class="co">#&gt;      - 30 – 20 = 10 days of July</span></span>
<span><span class="co">#&gt;      - 18 days of September until 17:47:19 UTC</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; So, in detail:</span></span>
<span><span class="co">#&gt;    - 55 years</span></span>
<span><span class="co">#&gt;    - 1 month</span></span>
<span><span class="co">#&gt;    - 28 days</span></span>
<span><span class="co">#&gt;    - From July 20, 2024, 20:17 UTC to July 20, 2024, 17:47:19 UTC: 23 hours, 30 minutes, and 19 seconds</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; Time Total:</span></span>
<span><span class="co">#&gt; - 55 years</span></span>
<span><span class="co">#&gt; - 1 month</span></span>
<span><span class="co">#&gt; - 28 days</span></span>
<span><span class="co">#&gt; - 23 hours</span></span>
<span><span class="co">#&gt; - 30 minutes</span></span>
<span><span class="co">#&gt; - 19 seconds</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; This is the exact time that has elapsed since Neil Armstrong's historic touchdown on the moon.</span></span></code></pre></div>
<p>That’s correct! Without any further guidance, the chat model decided
to call our tool function and successfully used its result in
formulating its response.</p>
<p>(Full disclosure: I originally tried this example with the default
model of <code>gpt-4o-mini</code> and it got the tool calling right but
the date math wrong, hence the explicit
<code>model="gpt-4o"</code>.)</p>
<p>This tool example was extremely simple, but you can imagine doing
much more interesting things from tool functions: calling APIs, reading
from or writing to a database, kicking off a complex simulation, or even
calling a complementary GenAI model (like an image generator). Or if you
are using ellmer in a Shiny app, you could use tools to set reactive
values, setting off a chain of reactive updates.</p>
</div>
<div class="section level3">
<h3 id="tool-inputs-and-outputs">Tool inputs and outputs<a class="anchor" aria-label="anchor" href="#tool-inputs-and-outputs"></a>
</h3>
<p>Remember that tool arguments come from the LLM, and tool results are
returned to the LLM. This implies that you should keep both as simple as
possible.</p>
<p>Inputs to a tool call, must be defined by
<code><a href="../reference/type_boolean.html">type_boolean()</a></code>, <code><a href="../reference/type_boolean.html">type_integer()</a></code>,
<code><a href="../reference/type_boolean.html">type_number()</a></code>, <code><a href="../reference/type_boolean.html">type_string()</a></code>,
<code><a href="../reference/type_boolean.html">type_enum()</a></code>, <code><a href="../reference/type_boolean.html">type_array()</a></code>, or
<code><a href="../reference/type_boolean.html">type_object()</a></code>. We recommend keeping them as simple as
possible, focussing on basic scalar types as much as you can.</p>
<p>The output of the tool call will be interpreted by the LLM, just as
if you had typed that information into the data. That means you’ll
generally want to produce text or other atomic vectors. For more complex
data, ellmer will automatically serialize the result to JSON, which LLMs
generally seem to be good at understanding.</p>
<p>To show off these ideas, here’s a slightly more complicated example
simulating a weather API that returns data for multiple cities at once.
The <code>get_weather()</code> function returns a data frame that ellmer
will automatically convert into JSON in row-major format, which our
experiments suggest is good for LLMs.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">raining</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>London <span class="op">=</span> <span class="st">"heavy"</span>, Houston <span class="op">=</span> <span class="st">"none"</span>, Chicago <span class="op">=</span> <span class="st">"overcast"</span><span class="op">)</span></span>
<span><span class="va">temperature</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>London <span class="op">=</span> <span class="st">"cool"</span>, Houston <span class="op">=</span> <span class="st">"hot"</span>, Chicago <span class="op">=</span> <span class="st">"warm"</span><span class="op">)</span></span>
<span><span class="va">wind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>London <span class="op">=</span> <span class="st">"strong"</span>, Houston <span class="op">=</span> <span class="st">"weak"</span>, Chicago <span class="op">=</span> <span class="st">"strong"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">get_weather</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cities</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    city <span class="op">=</span> <span class="va">cities</span>,</span>
<span>    raining <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">raining</span><span class="op">[</span><span class="va">cities</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    temperature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">temperature</span><span class="op">[</span><span class="va">cities</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    wind <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">wind</span><span class="op">[</span><span class="va">cities</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chat_openai.html">chat_openai</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Using <span style="color: #00BB00;">model</span> = <span style="color: #0000BB;">"gpt-4.1"</span>.</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">register_tool</span><span class="op">(</span><span class="fu"><a href="../reference/tool.html">tool</a></span><span class="op">(</span> </span>
<span>  <span class="va">get_weather</span>,</span>
<span>  <span class="st">"Report on weather conditions in multiple cities. For efficiency, request all </span></span>
<span><span class="st">  weather updates using a single tool call"</span>,</span>
<span>  cities <span class="op">=</span> <span class="fu"><a href="../reference/type_boolean.html">type_array</a></span><span class="op">(</span><span class="st">"City names"</span>, <span class="fu"><a href="../reference/type_boolean.html">type_string</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"Give me a weather udpate for London and Chicago"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">◯</span> [<span style="color: #0000BB;">tool call</span>] get_weather(cities = list("London", "Chicago"))</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">●</span> #&gt; <span style="font-style: italic;">[{"city":"London","raining":"heavy","temperature":"cool","wi…</span></span></span>
<span><span class="co">#&gt; Here is the latest weather update:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - London: Heavy rain, cool temperatures, and strong winds.</span></span>
<span><span class="co">#&gt; - Chicago: Overcast skies, warm temperatures, and strong winds.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Let me know if you need a more detailed forecast or other locations!</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, Joe Cheng, Aaron Jacobs, <a href="https://garrickadenbuie.com" class="external-link">Garrick Aden-Buie</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
